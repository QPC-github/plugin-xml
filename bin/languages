#!/usr/bin/env node

const fs = require("node:fs");
const path = require("node:path");

const linguistLanguages = require("linguist-languages");
const prettier = require("prettier");

function getSupportLanguages() {
  const supportLanguages = [];

  for (const language of Object.values(linguistLanguages)) {
    if (language.aceMode === "xml") {
      const { type, color, aceMode, languageId, ...config } = language;

      // Before we used linguist to get the languages, we had a
      // manually-maintained list. These two had been added manually. So in the
      // interest of not breaking anything, we'll add them back in here.
      if (language.name === "XML") {
        language.extensions?.push(".inx", ".runsettings");
        language.extensions?.sort();
      }

      supportLanguages.push({
        ...config,
        since: "0.1.0",
        parsers: ["xml"],
        linguistLanguageId: languageId,
        vscodeLanguageIds: ["xml"]
      });
    }
  }

  return supportLanguages;
}

const languages = JSON.stringify(getSupportLanguages());

const packagePath = path.join(path.dirname(__dirname), "package.json");
const packageConfig = JSON.parse(fs.readFileSync(packagePath, "utf8"));
const { plugins, ...prettierConfig } = packageConfig.prettier;

fs.writeFileSync(
  "src/languages.js",
  prettier.format(`module.exports = ${languages};`, { parser: "typescript", ...prettierConfig })
);
